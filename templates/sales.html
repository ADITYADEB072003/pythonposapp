{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">
    <!-- Page Header -->
    <div class="card bg-dark text-white shadow-lg mb-4">
        <div class="card-body p-4">
            <div class="d-flex align-items-center">
                <div class="bg-primary bg-opacity-75 rounded-3 me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-chart-line fa-lg"></i>
                </div>
                <div>
                    <h2 class="mb-0 text-white">Sales History</h2>
                    <p class="mb-0 text-white-50 small">Track, filter, and analyze sales performance.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-muted"><i class="fas fa-filter me-2"></i>Controls</h5>
            <button class="btn btn-sm btn-outline-secondary d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                Show Filters
            </button>
        </div>
        <div class="card-body collapse d-lg-block" id="filterCollapse">
            <div class="row g-3 align-items-end">
                <div class="col-md-6 col-lg-3">
                    <label for="start" class="form-label small fw-bold">Start Date</label>
                    <input type="date" name="start" id="start" value="{{ start }}" class="form-control">
                </div>
                <div class="col-md-6 col-lg-3">
                    <label for="end" class="form-label small fw-bold">End Date</label>
                    <input type="date" name="end" id="end" value="{{ end }}" class="form-control">
                </div>
                <div class="col-lg-3">
                     <label for="searchInput" class="form-label small fw-bold">Search</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by name...">
                </div>
                <div class="col-12 col-lg-3 d-flex gap-2">
                    <button id="filterBtn" class="btn btn-primary w-100">Apply</button>
                    <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h6 class="text-muted small">Total Sales</h6><h4 id="totalSales">₹0.00</h4></div></div></div>
        <div class="col-6 col-md-3"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h6 class="text-muted small">Total Items Sold</h6><h4 id="totalItems">0</h4></div></div></div>
        <div class="col-6 col-md-3"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h6 class="text-muted small">Avg. Sale Value</h6><h4 id="avgSale">₹0.00</h4></div></div></div>
        <div class="col-6 col-md-3"><div class="card h-100 shadow-sm"><div class="card-body text-center"><h6 class="text-muted small">Transactions</h6><h4 id="totalTransactions">0</h4></div></div></div>
    </div>

    <!-- Main Content Area: Table and Grouped View Toggle -->
    <div class="card shadow-sm">
        <div class="card-header bg-light border-0 d-flex justify-content-between align-items-center">
            <div class="btn-group" role="group">
                <button id="showTableView" class="btn btn-sm btn-primary active"><i class="fas fa-list me-2"></i>List View</button>
                <button id="showGroupView" class="btn btn-sm btn-outline-primary"><i class="fas fa-calendar-day me-2"></i>Group by Day</button>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-success" id="exportBtn"><i class="fas fa-file-csv me-2"></i>Export CSV</button>
            </div>
        </div>
        
        <!-- Table View -->
        <div id="tableView">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="salesTable">
                    <thead class="sticky-top bg-white">
                        <tr>
                            <th class="sortable" data-column="date" scope="col">Date</th>
                            <th class="sortable" data-column="name" scope="col">Item Name</th>
                            <th class="text-center sortable" data-column="quantity" scope="col">Qty</th>
                            <th class="text-end sortable" data-column="price" scope="col">Unit Price</th>
                            <th class="text-end sortable" data-column="total" scope="col">Total</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <!-- JS will render rows here -->
                    </tbody>
                </table>
            </div>
            <div id="table-empty-state" class="text-center p-5" style="display: none;">
                <h5 class="text-muted">No sales found</h5>
                <p>Try adjusting your filters or search term.</p>
            </div>
        </div>

        <!-- Grouped by Day View -->
        <div id="groupView" class="p-3" style="display: none;">
            <div class="accordion" id="grouped-sales-accordion">
                <!-- JS will render accordion items here -->
            </div>
             <div id="group-empty-state" class="text-center p-5" style="display: none;">
                <h5 class="text-muted">No sales data to group</h5>
                <p>Try adjusting your filters.</p>
            </div>
        </div>
    </div>
</div>

<style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable .fa-sort, .sortable .fa-sort-up, .sortable .fa-sort-down { margin-left: 5px; color: #aaa; }
    .table-hover tbody tr:hover { background-color: rgba(0,0,0,0.03); }
    .card { transition: all 0.2s ease-in-out; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. STATE MANAGEMENT & INITIALIZATION ---
    const salesData = [
        {% for sale in sales %}
        {
            _id: "{{ sale._id }}",
            date: new Date("{{ sale.date.isoformat() if sale.date else '' }}"),
            name: {{ sale.name | tojson | safe }},
            quantity: {{ sale.quantity or 0 }},
            price: {{ sale.price or 0 }},
            total: {{ (sale.quantity or 0) * (sale.price or 0) }}
        },
        {% endfor %}
    ];

    const state = {
        filters: {
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            search: ''
        },
        sorting: {
            column: 'date',
            direction: 'desc'
        },
        view: 'table' // 'table' or 'group'
    };

    // DOM Element references
    const UIElements = {
        tbody: document.getElementById('salesTableBody'),
        tableView: document.getElementById('tableView'),
        groupView: document.getElementById('groupView'),
        accordion: document.getElementById('grouped-sales-accordion'),
        tableEmptyState: document.getElementById('table-empty-state'),
        groupEmptyState: document.getElementById('group-empty-state'),
        totalSales: document.getElementById('totalSales'),
        totalItems: document.getElementById('totalItems'),
        avgSale: document.getElementById('avgSale'),
        totalTransactions: document.getElementById('totalTransactions')
    };

    // --- 2. CORE LOGIC (Filtering and Sorting) ---
    function getFilteredAndSortedData() {
        const filtered = salesData.filter(s => {
            const saleDate = s.date;
            const startDate = state.filters.start ? new Date(state.filters.start) : null;
            const endDate = state.filters.end ? new Date(state.filters.end) : null;
            
            if (startDate && saleDate < startDate) return false;
            if (endDate) {
                endDate.setHours(23, 59, 59, 999); // Include the whole end day
                if (saleDate > endDate) return false;
            }
            if (state.filters.search && !s.name.toLowerCase().includes(state.filters.search)) {
                return false;
            }
            return true;
        });

        return filtered.sort((a, b) => {
            const valA = a[state.sorting.column];
            const valB = b[state.sorting.column];
            const direction = state.sorting.direction === 'asc' ? 1 : -1;
            
            if (valA < valB) return -1 * direction;
            if (valA > valB) return 1 * direction;
            return 0;
        });
    }

    // --- 3. RENDERING FUNCTIONS ---
    function render() {
        const data = getFilteredAndSortedData();
        
        updateSummaryCards(data);

        if (state.view === 'table') {
            renderTableView(data);
            UIElements.tableView.style.display = 'block';
            UIElements.groupView.style.display = 'none';
        } else {
            renderGroupView(data);
            UIElements.tableView.style.display = 'none';
            UIElements.groupView.style.display = 'block';
        }
    }

    function renderTableView(data) {
        if (data.length === 0) {
            UIElements.tbody.innerHTML = '';
            UIElements.tableEmptyState.style.display = 'block';
            return;
        }
        UIElements.tableEmptyState.style.display = 'none';

        UIElements.tbody.innerHTML = data.map(sale => `
            <tr>
                <td>${sale.date.toLocaleDateString()} <small class="text-muted d-block">${sale.date.toLocaleTimeString()}</small></td>
                <td>${sale.name}</td>
                <td class="text-center">${sale.quantity}</td>
                <td class="text-end">₹${sale.price.toFixed(2)}</td>
                <td class="text-end fw-bold">₹${sale.total.toFixed(2)}</td>
            </tr>
        `).join('');
    }

    function renderGroupView(data) {
        if (data.length === 0) {
            UIElements.accordion.innerHTML = '';
            UIElements.groupEmptyState.style.display = 'block';
            return;
        }
        UIElements.groupEmptyState.style.display = 'none';

        const grouped = data.reduce((acc, sale) => {
            const day = sale.date.toDateString();
            if (!acc[day]) acc[day] = [];
            acc[day].push(sale);
            return acc;
        }, {});

        UIElements.accordion.innerHTML = Object.entries(grouped).map(([day, sales], index) => {
            const dayTotal = sales.reduce((sum, s) => sum + s.total, 0);
            return `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-${index}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${index}">
                            ${day} - <strong class="ms-2">₹${dayTotal.toFixed(2)}</strong>
                        </button>
                    </h2>
                    <div id="collapse-${index}" class="accordion-collapse collapse" data-bs-parent="#grouped-sales-accordion">
                        <div class="accordion-body p-0">
                            <ul class="list-group list-group-flush">
                                ${sales.map(s => `
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>${s.name} (x${s.quantity})</span>
                                        <strong>₹${s.total.toFixed(2)}</strong>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateSummaryCards(data) {
        const totalSales = data.reduce((sum, s) => sum + s.total, 0);
        const totalItems = data.reduce((sum, s) => sum + s.quantity, 0);
        const transactions = data.length;
        const avgSale = transactions > 0 ? totalSales / transactions : 0;
        
        UIElements.totalSales.textContent = `₹${totalSales.toFixed(2)}`;
        UIElements.totalItems.textContent = totalItems;
        UIElements.avgSale.textContent = `₹${avgSale.toFixed(2)}`;
        UIElements.totalTransactions.textContent = transactions;
    }

    function updateSortIcons() {
        document.querySelectorAll('.sortable').forEach(th => {
            const column = th.dataset.column;
            const icon = th.querySelector('.fas') || document.createElement('i');
            if (!th.querySelector('.fas')) {
                icon.classList.add('fas', 'fa-sort');
                th.appendChild(icon);
            }
            
            if (column === state.sorting.column) {
                icon.className = `fas fa-sort-${state.sorting.direction === 'asc' ? 'up' : 'down'}`;
            } else {
                icon.className = 'fas fa-sort';
            }
        });
    }

    // --- 4. EVENT LISTENERS ---
    document.getElementById('filterBtn').addEventListener('click', () => {
        state.filters.start = document.getElementById('start').value;
        state.filters.end = document.getElementById('end').value;
        state.filters.search = document.getElementById('searchInput').value.toLowerCase();
        render();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('start').value = '';
        document.getElementById('end').value = '';
        document.getElementById('searchInput').value = '';
        state.filters.start = '';
        state.filters.end = '';
        state.filters.search = '';
        render();
    });
    
    document.querySelector('#salesTable thead').addEventListener('click', e => {
        const th = e.target.closest('.sortable');
        if (!th) return;

        const column = th.dataset.column;
        if (state.sorting.column === column) {
            state.sorting.direction = state.sorting.direction === 'asc' ? 'desc' : 'asc';
        } else {
            state.sorting.column = column;
            state.sorting.direction = 'desc';
        }
        updateSortIcons();
        render();
    });

    document.getElementById('showTableView').addEventListener('click', () => {
        state.view = 'table';
        document.getElementById('showTableView').classList.add('active');
        document.getElementById('showGroupView').classList.remove('active');
        render();
    });

    document.getElementById('showGroupView').addEventListener('click', () => {
        state.view = 'group';
        document.getElementById('showGroupView').classList.add('active');
        document.getElementById('showTableView').classList.remove('active');
        render();
    });
    
    document.getElementById('exportBtn').addEventListener('click', () => {
        const data = getFilteredAndSortedData();
        const headers = ["Date", "Time", "Item", "Quantity", "Unit Price", "Total"];
        const csvContent = [
            headers.join(','),
            ...data.map(s => [
                s.date.toLocaleDateString(),
                s.date.toLocaleTimeString(),
                `"${s.name}"`,
                s.quantity,
                s.price.toFixed(2),
                s.total.toFixed(2)
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'sales_history.csv';
        link.click();
        URL.revokeObjectURL(link.href);
    });

    // --- 5. INITIAL RENDER ---
    updateSortIcons();
    render();
});
</script>
{% endblock %}
