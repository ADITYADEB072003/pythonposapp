{% extends "base.html" %}
{% block content %}
<h2 class="mb-3 fw-bold text-primary"><i class="bi bi-box-seam"></i> Inventory</h2>

<div class="row mb-4 g-3">
  <div class="col-12">
    <div class="card shadow-sm rounded-4 border-primary">
      <div class="card-body">
        <form id="inventory-form" action="{{ url_for('inventory') }}" method="POST" enctype="multipart/form-data" class="row g-3 align-items-end">
          <div class="col-12 col-md-6 col-lg-2">
            <input id="item_code" name="item_code" placeholder="Item Code" class="form-control rounded-pill border-info" required>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <input id="name" name="name" placeholder="Item Name" class="form-control rounded-pill border-info" required>
          </div>
          <div class="col-12 col-md-6 col-lg-2">
            <input id="price" name="price" type="number" step="0.01" placeholder="Price" class="form-control rounded-pill border-info" required>
          </div>
          <div class="col-12 col-md-6 col-lg-1">
            <input id="quantity" name="quantity" type="number" placeholder="Qty" class="form-control rounded-pill border-info" required>
          </div>
          <div class="col-12 col-md-6 col-lg-2">
            <input id="image" name="image" type="file" class="form-control rounded-pill border-info" accept="image/*">
          </div>
          <div class="col-12 col-md-6 col-lg-2 d-grid">
            <button id="form-submit" type="submit" class="btn btn-gradient-primary rounded-pill w-100"><i class="bi bi-plus-circle"></i> Add / Update</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card shadow rounded-4 border-0 mb-3">
  <div class="card-body p-0">
    <div class="d-none d-md-block">
      <table class="table table-hover align-middle mb-0" id="inventory-table">
        <thead class="table-primary">
          <tr>
            <th>Image</th>
            <th>Item Code</th>
            <th>Name</th>
            <th>Price (₹)</th>
            <th>Quantity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr class="table-row" data-id="{{ item._id }}" data-code="{{ item.item_code }}" data-name="{{ item.name }}" data-price="{{ item.price }}" data-quantity="{{ item.quantity }}">
            <td>
              {% if item.image %}
                <img src="{{ url_for('static', filename='images/' + item.image) }}" class="rounded shadow-sm border border-info" style="height:42px; width:42px; object-fit:cover;">
              {% else %}
                <span class="text-secondary">No Image</span>
              {% endif %}
            </td>
            <td class="item-code fw-bold">{{ item.item_code }}</td>
            <td class="item-name text-dark">{{ item.name }}</td>
            <td class="item-price text-success">{{ "%.2f"|format(item.price) }}</td>
            <td class="item-quantity text-info">{{ item.quantity }}</td>
            <td>
              <button type="button" class="btn btn-outline-info btn-sm btn-edit rounded-pill me-1"><i class="bi bi-pencil-square"></i> Edit</button>
              <form action="{{ url_for('delete_inventory', item_id=item._id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete {{ item.name }}?');">
                <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill"><i class="bi bi-trash"></i> Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Mobile card view -->
    <div class="d-block d-md-none">
      {% for item in items %}
      <div class="card mb-2 shadow-sm border-info" data-id="{{ item._id }}" data-code="{{ item.item_code }}" data-name="{{ item.name }}" data-price="{{ item.price }}" data-quantity="{{ item.quantity }}">
        <div class="card-body py-2 px-3 d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <span class="fw-bold text-primary me-2">#{{ item.item_code }}</span>
            <span class="fw-semibold text-dark flex-grow-1">{{ item.name }}</span>
          </div>
          <div class="mb-1"><span class="text-success">₹{{ "%.2f"|format(item.price) }}</span> | <span class="text-info">Qty: {{ item.quantity }}</span></div>
          <div class="mt-2">
            <button type="button" class="btn btn-outline-info btn-sm btn-edit rounded-pill me-1"><i class="bi bi-pencil-square"></i> Edit</button>
            <form action="{{ url_for('delete_inventory', item_id=item._id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete {{ item.name }}?');">
              <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill"><i class="bi bi-trash"></i> Delete</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('inventory-form');
    const itemCodeInput = document.getElementById('item_code');
    const submitButton = document.getElementById('form-submit');
    const originalFormAction = form.action;

    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            let parent = this.closest('[data-id]');
            form.action = `/inventory/edit/${parent.dataset.id}`;
            itemCodeInput.value = parent.dataset.code;
            document.getElementById('name').value = parent.dataset.name;
            document.getElementById('price').value = parent.dataset.price;
            document.getElementById('quantity').value = parent.dataset.quantity;
            itemCodeInput.readOnly = false;
            submitButton.innerHTML = '<i class="bi bi-check-circle"></i> Update Item';
            submitButton.classList.replace('btn-gradient-primary', 'btn-warning');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });

    form.addEventListener('reset', function() {
        form.action = originalFormAction;
        itemCodeInput.readOnly = true;
        submitButton.innerHTML = '<i class="bi bi-plus-circle"></i> Add / Update';
        submitButton.classList.replace('btn-warning', 'btn-gradient-primary');
    });
});
</script>

<style>
.btn-gradient-primary { background: linear-gradient(90deg,#2564f6 0%,#44caff 100%); color: #fff; border: none; }
.btn-gradient-primary:hover, .btn-gradient-primary:focus { background: linear-gradient(90deg,#1162e6 0%,#23b6e4 100%); color:white; }
.card { border-radius: 1.1rem !important; }
.form-control:focus { border-color: #44caff; box-shadow: 0 0 0 0.2rem rgba(68,202,255,.15); }
</style>
{% endblock %}
